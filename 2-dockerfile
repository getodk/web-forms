FROM node:22.12.0-slim AS builder

WORKDIR /app

# for tree-sitter
RUN apt-get update && apt-get install -y \
    python3 \
    make \
    g++ \
    curl \
    git \
    cmake \
    xz-utils \
    openjdk-17-jre-headless \
    && rm -rf /var/lib/apt/lists/*

COPY package.json yarn.lock ./
RUN yarn install --frozen-lockfile --production

COPY . .

RUN yarn install --frozen-lockfile

for tree-sitter
RUN git clone https://github.com/emscripten-core/emsdk.git /emsdk && \
    cd /emsdk && \
    ./emsdk install latest && \
    ./emsdk activate latest

RUN cd /emsdk && \
    . ./emsdk_env.sh && \
    cd /app && \
    yarn build --force

# -----
FROM ubuntu:22.04

RUN apt-get update && \
    apt-get install -y curl gnupg && \
    curl -fsSL https://deb.nodesource.com/setup_22.x | bash - && \
    apt-get install -y nodejs && \
    npm install -g yarn && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /app

COPY --from=builder /app /app

# install playwright browsers + system deps
RUN yarn playwright install --with-deps

RUN apt-get update && \
    apt-get install -y xvfb xauth libgl1 libxrender1 libxtst6 && \
    rm -rf /var/lib/apt/lists/*

CMD ["bash", "-c", "Xvfb :99 -ac +extension GLX +render -screen 0 1280x720x24 -nolisten tcp > /dev/null 2>&1 & sleep 2; export DISPLAY=:99; PWDEBUG=1 yarn workspace @getodk/web-forms test:e2e:visual-chromium"]
