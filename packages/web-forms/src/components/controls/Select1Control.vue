<script lang="ts" setup>
import type { SelectNode } from '@getodk/xforms-engine';
import { inject, ref } from 'vue';
import ControlLabel from '../ControlLabel.vue';
import ValidationMessage from '../ValidationMessage.vue';
import ColumnarAppearance from '../appearances/ColumnarAppearance.vue';
import FieldListTable from '../appearances/FieldListTable.vue';
import LikertWidget from '../widgets/LikertWidget.vue';
import RadioButton from '../widgets/RadioButton.vue';
import SearchableDropdown from '../widgets/SearchableDropdown.vue';
import UnsupportedAppearance from './UnsupportedAppearance.vue';

const props = defineProps<{question: SelectNode}>();

const hasColumnsAppearance = [...props.question.appearances].filter(a => a.startsWith('columns')).length > 0;

const fieldListRelatedAppearances = new Set(['label', 'list-nolabel', 'list']);
const hasFieldListRelatedAppearance = !![...props.question.appearances].find(a => fieldListRelatedAppearances.has(a));

const touched = ref(false);
const submitPressed = inject<boolean>('submitPressed');

</script>

<template>
	<ControlLabel v-if="!hasFieldListRelatedAppearance" :question="question" />
  
	<SearchableDropdown v-if="question.appearances.autocomplete || question.appearances.minimal" :question="question" @change="touched = true" />

	<LikertWidget v-else-if="question.appearances.likert" :question="question" @change="touched = true" />

	<FieldListTable v-else-if="hasFieldListRelatedAppearance" :appearances="question.appearances">
		<template #firstColumn>
			<ControlLabel :question="question" />
		</template>
		<template #default>
			<RadioButton :question="question" @change="touched = true" />
		</template>
	</FieldListTable>

	<ColumnarAppearance v-else-if="hasColumnsAppearance" :appearances="question.appearances">
		<RadioButton :question="question" @change="touched = true" />
	</ColumnarAppearance>		

	<template v-else>
		<template v-if="question.appearances.map || question.appearances['image-map']">
			<UnsupportedAppearance :appearance="[...question.appearances].toString()" node-type="Select1" />
		</template>
		<div class="default-appearance">
			<RadioButton :question="question" @change="touched = true" />
		</div>
	</template>

	<ValidationMessage 
		:message="question.validationState.violation?.message.asString" 
		:show-message="touched || submitPressed"
		:add-placeholder="!hasFieldListRelatedAppearance"
	/>
</template>

<style lang="scss" scoped>
@import 'primeflex/core/_variables.scss';
label{
	margin-bottom: 0.75rem;
}

.default-appearance {
	width: 100%;
	display: flex;
	flex-direction: column;
	gap: 1rem;

	@media screen and (min-width: #{$md}) {
		min-width: 50%;
		width: max-content;
		max-width: 100%;
	}
}
</style>