FROM node:20.19.3-slim AS builder
WORKDIR /app

# for tree-sitter
RUN apt-get update && apt-get install -y \
    python3 make g++ curl git cmake xz-utils openjdk-17-jre-headless \
    && rm -rf /var/lib/apt/lists/*

COPY package.json yarn.lock ./
RUN yarn install --frozen-lockfile --production
COPY . .
RUN yarn install --frozen-lockfile

# for tree-sitter
RUN git clone https://github.com/emscripten-core/emsdk.git /emsdk && \
    cd /emsdk && ./emsdk install latest && ./emsdk activate latest

RUN cd /emsdk && . ./emsdk_env.sh && cd /app && yarn build --force

#--------

FROM --platform=linux/amd64 mcr.microsoft.com/playwright:v1.48.0-focal

# install node 20.19.3 from NodeSource with correct GPG key
RUN apt-get update && \
    apt-get install -y ca-certificates curl gnupg && \
    mkdir -p /etc/apt/keyrings && \
    curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | \
    gpg --dearmor --batch --yes -o /etc/apt/keyrings/nodesource.gpg && \
    echo "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_20.x nodistro main" > /etc/apt/sources.list.d/nodesource.list && \
    apt-get update && \
    apt-get install -y nodejs=20.19.3-1nodesource1 && \
    npm i -g yarn@1.22.22 && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /app
COPY --from=builder /app /app

# install playwright browsers only
RUN yarn playwright install

CMD ["bash", "-c", "\
  Xvfb :99 -ac +extension GLX +render -screen 0 1280x720x24 -nolisten tcp > /dev/null 2>&1 & \
  sleep 3; \
  export DISPLAY=:99; \
  PWDEBUG=1 yarn workspace @getodk/web-forms test:e2e:visual-chromium --reporter=html \
"]
